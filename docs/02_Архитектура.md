# Архитектура приложения

## Общая архитектура

Приложение построено по классической архитектуре Android с использованием паттерна MVC (Model-View-Controller):

- **Model** - классы данных и бизнес-логики (Level, DifficultySettings, ExpressionGenerator, StatsManager)
- **View** - XML-разметки и Activity классы
- **Controller** - Activity классы, управляющие взаимодействием между Model и View

## Архитектура приложения (MVC)

### Model (Модель данных и логики)

Модель содержит всю бизнес-логику приложения и управление данными:

#### `Level` – управление уровнем сложности
- Хранит номер уровня (1-5)
- Определяет параметры сложности для каждого уровня
- Предоставляет доступ к настройкам через геттеры
- Использует `DifficultySettings` для хранения конфигурации

#### `DifficultySettings` – настройки сложности
- Максимальное число в примерах
- Доступные арифметические операции (+, -, ×, ÷)
- Количество действий (минимум и максимум)
- Разрешение использования скобок
- Время на вопрос в секундах

#### `ExpressionGenerator` – генерация математических выражений
- Генерация арифметических примеров различной сложности
- Поддержка выражений с 1, 2 и 3 действиями
- Учет приоритета операций
- Генерация пошаговых решений
- Внутренний класс `Expression` для хранения выражения, результата и решения

#### `StatsManager` – управление статистикой
- Сохранение и загрузка статистики через SharedPreferences
- Отслеживание лучших результатов
- Управление достигнутыми уровнями
- Хранение истории результатов
- Методы для сброса статистики

### View (Представление)

Представление отвечает за отображение данных пользователю:

#### XML Layout файлы
- **`activity_main.xml`** – главное меню с выбором сложности
- **`activity_game.xml`** – игровой экран с полем вопроса, таймером, жизнями
- **`activity_results.xml`** – экран результатов с детальной статистикой
- **`activity_statistics.xml`** – экран статистики с достижениями
- **`activity_level_up.xml`** – экран повышения уровня

#### Специализированные View компоненты
- **Игровые элементы** – TextView для вопроса, EditText для ввода, кнопки Да/Нет
- **Индикаторы** – ProgressBar для прогресса, ImageView для жизней (сердечки)
- **Таймеры** – TextView для отображения оставшегося времени
- **Карточки** – LinearLayout с drawable фонами для статистики и достижений
- **Оверлеи** – LinearLayout для показа решений и меню паузы

### Controller (Контроллер)

Контроллер связывает View и Model, обрабатывает события пользователя:

#### `MainActivity` – главный контроллер меню
- Инициализация главного экрана
- Обработка выбора сложности через RadioGroup
- Навигация в GameActivity с передачей выбранной сложности
- Управление цветами выбранных опций

#### `GameActivity` – основной игровой контроллер
- Управление игровым процессом
- Генерация вопросов через ExpressionGenerator
- Обработка ответов пользователя
- Управление таймерами и жизнями
- Контроль состояния игры (пауза, завершение)
- Навигация в ResultsActivity или LevelUpActivity
- Интеграция со StatsManager для сохранения статистики

#### `ResultsActivity` – контроллер результатов
- Отображение результатов завершенной сессии
- Расчет оценок и рейтингов
- Обновление статистики через StatsManager
- Определение и показ достижений
- Навигация в другие экраны (новая игра, статистика, меню)

#### `StatisticsActivity` – контроллер статистики
- Отображение подробной статистики из StatsManager
- Формирование визуализации прогресса
- Динамическое создание карточек достижений
- Предоставление советов для улучшения
- Функция сброса статистики

#### `LevelUpActivity` – контроллер повышения уровня
- Отображение поздравления с повышением уровня
- Сохранение нового уровня через SharedPreferences
- Навигация на следующий уровень или в меню
- Интеграция со StatsManager для обновления высшего уровня

### Взаимодействие компонентов MVC

```
┌─────────────────────────────────────────────────────────┐
│                      Controller                         │
│  (MainActivity, GameActivity, ResultsActivity, etc.)     │
│                                                          │
│  • Обрабатывает события пользователя                    │
│  • Вызывает методы Model                                │
│  • Обновляет View                                       │
└──────────────┬──────────────────────┬───────────────────┘
               │                      │
               ▼                      ▼
    ┌──────────────────┐    ┌──────────────────┐
    │      Model       │    │       View        │
    │                  │    │                   │
    │ • Level          │    │ • XML Layouts    │
    │ • Difficulty     │    │ • UI Components   │
    │ • ExpressionGen  │    │ • Drawables       │
    │ • StatsManager   │    │ • Resources       │
    │                  │    │                   │
    │ Бизнес-логика    │    │ Отображение      │
    └──────────────────┘    └───────────────────┘
```

**Принцип работы:**
1. Пользователь взаимодействует с View (нажимает кнопку, вводит ответ)
2. Controller получает событие и обрабатывает его
3. Controller обращается к Model для выполнения бизнес-логики
4. Model возвращает результат Controller
5. Controller обновляет View с новыми данными

**Пример потока:**
```
Пользователь вводит ответ в GameActivity (View)
    ↓
GameActivity.checkInputAnswer() (Controller)
    ↓
ExpressionGenerator/Level (Model) - проверка ответа
    ↓
GameActivity обновляет UI (View) - показывает результат
    ↓
StatsManager (Model) - сохраняет статистику
```

## Ключевые классы. Игровая логика

### Класс `Level`
- Хранит номер уровня сложности (1-5)
- Определяет параметры для каждого уровня через `DifficultySettings`
- Методы: `getLevelNumber()`, `getMaxNumber()`, `getOperations()`, `getActionsCount()`, `getTimePerQuestion()`
- Автоматически настраивает сложность в зависимости от номера уровня

### Класс `DifficultySettings`
- Хранит конфигурацию сложности: максимальное число, доступные операции, количество действий
- Определяет разрешение использования скобок
- Устанавливает время на вопрос для каждого уровня
- Предоставляет геттеры для доступа к настройкам

### Класс `ExpressionGenerator`
- **Генерация арифметических примеров**: создает выражения с 1, 2 или 3 действиями
- **Учет приоритета операций**: правильно расставляет скобки при смешанных операциях
- **Гарантия корректности**: предотвращает деление на ноль, деление с остатком, отрицательные результаты
- **Пошаговое решение**: генерирует подробное решение для каждого примера
- Внутренний класс `Expression` хранит выражение, результат и пошаговое решение

### Класс `StatsManager`
- **Управление статистикой**: сохранение и загрузка через SharedPreferences
- Методы: `getHighestLevel()`, `getBestScore()`, `getSessionsCount()`, `getTotalTime()`
- **Отслеживание прогресса**: хранение результатов по каждому уровню
- **История результатов**: сохранение последних 10 результатов
- Автоматическое обновление лучших результатов при улучшении

## Ключевые классы. Интерфейс и управление

### Класс `GameActivity`
- **Управление игровым процессом**: генерация вопросов, проверка ответов, управление жизнями
- **Таймеры**: обратный отсчет на вопрос и общий таймер игры
- Методы: `generateNewQuestion()`, `checkInputAnswer()`, `checkYesNoAnswer()`, `startCountdownTimer()`
- **Состояния игры**: пауза, завершение, блокировка кнопок
- **Обратная связь**: показ решения при ошибке через `showSolutionOverlay()`
- Навигация в `ResultsActivity` или `LevelUpActivity` при завершении/повышении уровня

### Класс `MainActivity`
- Инициализация главного меню
- Обработка выбора сложности через `RadioGroup`
- Обновление цветов выбранных опций через `updateDifficultyColors()`
- Навигация в `GameActivity` с передачей выбранной сложности

### Класс `ResultsActivity`
- Отображение результатов завершенной сессии
- Расчет оценок и рейтингов через `calculateScore()` и `getRating()`
- Обновление статистики через `StatsManager`
- Определение и показ достижений через `showAchievements()`
- Автоматическое повышение уровня при результате ≥90%

### Класс `StatisticsActivity`
- Отображение подробной статистики из `StatsManager`
- Формирование визуализации прогресса через `createProgressBar()`
- Динамическое создание карточек достижений через `addAchievementView()`
- Предоставление советов для улучшения через `getImprovementTips()`
- Функция сброса статистики с подтверждением

### Класс `LevelUpActivity`
- Отображение поздравления с повышением уровня
- Сохранение нового уровня через SharedPreferences
- Навигация на следующий уровень или возврат в меню
- Интеграция со `StatsManager` для обновления высшего уровня

## Структура проекта

```
counting-trainer-android/
├── app/
│   ├── build.gradle.kts          # Конфигурация сборки приложения
│   ├── src/
│   │   └── main/
│   │       ├── AndroidManifest.xml    # Манифест приложения
│   │       ├── java/com/example/countingtrainer/
│   │       │   ├── MainActivity.java         # Главное меню
│   │       │   ├── GameActivity.java         # Игровой экран
│   │       │   ├── ResultsActivity.java      # Экран результатов
│   │       │   ├── StatisticsActivity.java   # Экран статистики
│   │       │   ├── LevelUpActivity.java      # Экран повышения уровня
│   │       │   ├── Level.java                # Класс уровня сложности
│   │       │   ├── DifficultySettings.java  # Настройки сложности
│   │       │   ├── ExpressionGenerator.java  # Генератор выражений
│   │       │   └── StatsManager.java          # Менеджер статистики
│   │       └── res/
│   │           ├── layout/                    # XML разметки
│   │           ├── drawable/                  # Графические ресурсы
│   │           ├── values/                   # Строки, цвета, темы
│   │           └── raw/                       # Звуковые файлы
│   └── proguard-rules.pro
├── build.gradle.kts              # Корневой build файл
├── gradle/
│   └── libs.versions.toml        # Версии зависимостей
└── settings.gradle.kts
```

## Схема взаимодействия компонентов

```
┌─────────────────┐
│  MainActivity   │
│  (Главное меню) │
└────────┬────────┘
         │ Intent (difficulty)
         ▼
┌─────────────────┐
│  GameActivity   │◄─────┐
│  (Игровой экран)│      │
└────────┬────────┘      │
         │               │
         │               │ Intent (correct_answers, wrong_answers, time, level)
         │               │
         ▼               │
┌─────────────────┐      │
│ ResultsActivity │      │
│  (Результаты)   │      │
└────────┬────────┘      │
         │               │
         │ Intent        │ Intent (current_level, correct_answers, time)
         ▼               │
┌─────────────────┐      │
│StatisticsActivity│     │
│  (Статистика)   │      │
└─────────────────┘      │
                         │
                         │ Intent (current_level, correct_answers, time)
                         │
                         ▼
                ┌─────────────────┐
                │ LevelUpActivity │
                │ (Повышение      │
                │   уровня)       │
                └─────────────────┘
```

## Хранение данных

### SharedPreferences

Приложение использует два файла SharedPreferences для хранения данных:

1. **game_prefs** - настройки игры
   - `current_level` (int) - текущий выбранный уровень сложности

2. **game_stats** - статистика игры
   - `highest_level` (int) - высший достигнутый уровень
   - `sessions_count` (int) - количество сыгранных сессий
   - `best_score` (int) - лучший процент правильных ответов
   - `total_time` (long) - общее время игры в секундах
   - `level_X_result` (int) - последний результат для уровня X (X = 1-5)
   - `last_results` (String) - последние 10 результатов (через запятую)

### Схема данных (SharedPreferences)

```
game_prefs
├── current_level: int

game_stats
├── highest_level: int
├── sessions_count: int
├── best_score: int
├── total_time: long
├── level_1_result: int
├── level_2_result: int
├── level_3_result: int
├── level_4_result: int
├── level_5_result: int
└── last_results: String (CSV формат)
```

## Поток данных

### Игровая сессия

1. **MainActivity** → Пользователь выбирает сложность → Intent передается в **GameActivity**
2. **GameActivity** → Создается объект **Level** на основе выбранной сложности
3. **GameActivity** → Использует **ExpressionGenerator** для генерации вопросов
4. **GameActivity** → Отслеживает ответы, время, жизни
5. При завершении игры → Данные передаются в **ResultsActivity** через Intent
6. **ResultsActivity** → Использует **StatsManager** для сохранения статистики
7. **StatsManager** → Сохраняет данные в SharedPreferences

### Повышение уровня

1. **GameActivity** → При 10 правильных ответах подряд → Переход в **LevelUpActivity**
2. **LevelUpActivity** → Сохраняет новый уровень через SharedPreferences
3. При выборе "Следующий уровень" → Возврат в **GameActivity** с новым уровнем

## Жизненный цикл Activity

### GameActivity

```
onCreate()
  ├── Инициализация UI элементов
  ├── Загрузка уровня из SharedPreferences
  ├── Создание объекта Level
  ├── Настройка слушателей кнопок
  ├── Генерация первого вопроса
  └── Запуск таймера

onPause()
  └── Автоматическая пауза игры

onResume()
  └── Игра остается на паузе (пользователь решает)

onDestroy()
  ├── Освобождение MediaPlayer
  └── Остановка всех Handler callbacks
```

## Обработка состояний

### Состояния игры в GameActivity

- `isPaused` - игра на паузе
- `isGameEnded` - игра завершена
- `lives` - количество жизней (0-3)
- `isAnswerButtonLocked` - блокировка кнопок ответа (предотвращение двойных кликов)

### Обработка жизненного цикла

- При `onPause()` игра автоматически ставится на паузу
- При `onResume()` игра остается на паузе, пользователь может продолжить
- При `onBackPressed()` открывается/закрывается меню паузы
- При уничтожении Activity все ресурсы освобождаются

## Потоки выполнения

### Основной поток (UI Thread)

Все операции с UI выполняются в главном потоке:
- Обновление TextView, Button, ProgressBar
- Показ/скрытие View элементов
- Обработка кликов

### Handler для таймеров

Используется `Handler` с `Looper.getMainLooper()` для:
- Обратного отсчета времени на вопрос
- Общего таймера игры
- Автоматического скрытия оверлея с решением

## Обработка ошибок

- **Деление на ноль** - проверяется перед выполнением операции
- **Отрицательные результаты** - предотвращаются на легких уровнях
- **Деление с остатком** - генерируются только примеры с целым результатом
- **Пустой ввод** - проверяется перед проверкой ответа
- **Некорректный ввод** - обрабатывается через try-catch при парсинге числа

## Производительность

- Использование `Handler.postDelayed()` вместо создания новых потоков
- Переиспользование объектов (MediaPlayer, Random)
- Минимизация операций в UI потоке
- Эффективное использование SharedPreferences (apply() вместо commit())

